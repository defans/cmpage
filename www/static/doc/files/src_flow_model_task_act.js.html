<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src\flow\model\task_act.js</title>
  
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="stylesheet" href="../assets/vendor/bootstrap/css/bootstrap.min.css">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
</head>
<body class="yui3-smart">
 <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
               <a class="navbar-brand mainlogo" href="/static/doc/index.html">
             
            <img alt="" src="../assets/css/logo.png" title="">
            
                
          </a>
            </div>
            <div id="navbar" class="navbar-collapse collapse">
                 <ul class="nav navbar-nav">
                    
                    <li><a href="/home/index/index">首页</a>
                    </li>
                    
                    <li><a href="/static/doc/index.html">文档</a>
                    </li>
                    
                    <li><a href="/admin/index/index">演示</a>
                    </li>
                    
                    <li><a href="/home/index/log">日志</a>
                    </li>
                    
                </ul>
               <div class="navbar-form navbar-right filterAPi" autocomplete="off">
                <input type="text" id='txtSearchAPI' class="form-control search-query" placeholder="Search for API" />
                 <ul id="filterList" class="filterItems dropdown-menu" role="menu"></ul>
                </div>
            </div>
        </div>
    </nav>
    <div id="sidebar">
    <h3>Modules/Classes</h3>
        <div id="api-tabview-filter">
            <input id='txtSearch' type="search" class="form-control" placeholder="Type to filter Modules/Classes">
        </div>
        <dl id="sidebar_list">
             
                <dt>
                    <span class="glyphicon glyphicon-minus"></span>
                    <a href="../modules/admin.controller.html">admin.controller</a>
                </dt>
                <dd>
                    <ul>
                   
                       <li>
                            
                           <a href="../classes/admin.controller.base.html">admin.controller.base</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/admin.controller.code.html">admin.controller.code</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/admin.controller.index.html">admin.controller.index</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/admin.controller.mob.html">admin.controller.mob</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                    </ul>
                </dd>
             
                <dt>
                    <span class="glyphicon glyphicon-minus"></span>
                    <a href="../modules/admin.service.html">admin.service</a>
                </dt>
                <dd>
                    <ul>
                   
                       <li>
                            
                           <a href="../classes/admin.service.code.html">admin.service.code</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/admin.service.code_list.html">admin.service.code_list</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/admin.service.code_lookup.html">admin.service.code_lookup</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/admin.service.groupuser.html">admin.service.groupuser</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/admin.service.groupuser_add.html">admin.service.groupuser_add</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/admin.service.log.html">admin.service.log</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/admin.service.login.html">admin.service.login</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/admin.service.privilege.html">admin.service.privilege</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/admin.service.teamuser.html">admin.service.teamuser</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/admin.service.teamuser_add.html">admin.service.teamuser_add</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/admin.service.user.html">admin.service.user</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                    </ul>
                </dd>
             
                <dt>
                    <span class="glyphicon glyphicon-minus"></span>
                    <a href="../modules/cmpage.controller.html">cmpage.controller</a>
                </dt>
                <dd>
                    <ul>
                   
                       <li>
                            
                           <a href="../classes/cmpage.controller.base.html">cmpage.controller.base</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/cmpage.controller.mob.html">cmpage.controller.mob</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/cmpage.controller.module.html">cmpage.controller.module</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/cmpage.controller.page.html">cmpage.controller.page</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/cmpage.controller.utils.html">cmpage.controller.utils</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                    </ul>
                </dd>
             
                <dt>
                    <span class="glyphicon glyphicon-minus"></span>
                    <a href="../modules/cmpage.logic.html">cmpage.logic</a>
                </dt>
                <dd>
                    <ul>
                   
                       <li>
                            
                           <a href="../classes/cmpage.logic.page.html">cmpage.logic.page</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                    </ul>
                </dd>
             
                <dt>
                    <span class="glyphicon glyphicon-minus"></span>
                    <a href="../modules/cmpage.service.html">cmpage.service</a>
                </dt>
                <dd>
                    <ul>
                   
                       <li>
                            
                           <a href="../classes/cmpage.service.area.html">cmpage.service.area</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/cmpage.service.base.html">cmpage.service.base</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/cmpage.service.file_list.html">cmpage.service.file_list</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/cmpage.service.page.html">cmpage.service.page</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/cmpage.service.page_excel.html">cmpage.service.page_excel</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/cmpage.service.page_lookup.html">cmpage.service.page_lookup</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/cmpage.service.page_mob.html">cmpage.service.page_mob</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/cmpage.service.utils.html">cmpage.service.utils</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/cmpage.cmpage_global.html">cmpage.cmpage_global</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/cmpage.cmpage_global_flow.html">cmpage.cmpage_global_flow</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                    </ul>
                </dd>
             
                <dt>
                    <span class="glyphicon glyphicon-minus"></span>
                    <a href="../modules/demo.model.html">demo.model</a>
                </dt>
                <dd>
                    <ul>
                   
                       <li>
                            
                           <a href="../classes/flow.model.proc_assign.html">flow.model.proc_assign</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/cmpage.service.appr.html">cmpage.service.appr</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/flow.model.proc.html">flow.model.proc</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/flow.model.task.html">flow.model.task</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/flow.model.task_act.html">flow.model.task_act</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/flow.model.task_act_appr.html">flow.model.task_act_appr</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                    </ul>
                </dd>
             
                <dt>
                    <span class="glyphicon glyphicon-minus"></span>
                    <a href="../modules/flow.controller.html">flow.controller</a>
                </dt>
                <dd>
                    <ul>
                   
                       <li>
                            
                           <a href="../classes/flow.controller.act.html">flow.controller.act</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/flow.controller.base.html">flow.controller.base</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/flow.controller.proc.html">flow.controller.proc</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/flow.controller.task.html">flow.controller.task</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/flow.controller.task_act.html">flow.controller.task_act</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                    </ul>
                </dd>
             
                <dt>
                    <span class="glyphicon glyphicon-minus"></span>
                    <a href="../modules/flow.model.html">flow.model</a>
                </dt>
                <dd>
                    <ul>
                   
                       <li>
                            
                           <a href="../classes/flow.model.act.html">flow.model.act</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/flow.model.act_path.html">flow.model.act_path</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                    </ul>
                </dd>
             
        </dl>
</div>
   
    <div class="stdoc-content">
        <!--     <form id="options-form" class="form-inline pull-right">
        Show:
        <label for="api-show-inherited" class="checkbox">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected" class="checkbox">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private" class="checkbox">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated" class="checkbox">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </form>

 -->
        <div class="apidocs">
            <div id="docs-main">
                <div class="content">
                    <div class="page-header">
    <h1>src\flow\model\task_act.js <small>File</small></h1>
</div>

<div class="file">
    <pre class="prettyprint linenums" id='src_code'>
&#x27;use strict&#x27;;
// +----------------------------------------------------------------------
// | CmPage [ 通用页面框架 ]
// +----------------------------------------------------------------------
// | Licensed under the Apache License, Version 2.0
// +----------------------------------------------------------------------
// | Author: defans &lt;defans@sina.cn&gt;
// +----------------------------------------------------------------------

/**
 * 提供工作流的活动节点运转的相关方法，业务相关，供flow/model/act.js的方法进行调用&lt;br/&gt;
 * 具体的业务相关的工作流活动的子类可以继承本类，来增加定制的业务逻辑
 * @class flow.model.task_act
 */
export default class extends think.model.base {
    act = {};  //当前流程模板的节点设置
    taskAct = {};  //当前流程实例节点
    user = {};  //当前用户
    fromTaskActs = [];   //来源节点列表
    toTaskActs = [];   //去向节点列表
    toPaths = [];   //去向路径列表

    /**
     * 是否可以运行一个流程实例的活动(流程节点)
     * @method  canRun
     * @return {boolean}  判断值
     */
    async canRun(){
        let taskAct = this.taskAct;
        let act = this.act;
        cmpage.debug(taskAct,&#x27;task_act.canRun --- taskAct --- 根据节点状态判断&#x27;);
        cmpage.debug(act,&#x27;task_act.canRun --- act --- 根据节点状态判断&#x27;);
        if(act.c_type === cmpage.enumActType.START  || act.c_type === cmpage.enumActType.DUMMY || act.c_type === cmpage.enumActType.END
            || (taskAct.c_status === cmpage.enumTaskActStatus.SUSPEND &amp;&amp; taskAct.c_from_rule !== cmpage.enumActFromRule.DEFINE) ){
            return true;
        }else if(taskAct.c_status === cmpage.enumTaskActStatus.NO_BEGIN || taskAct.c_status === cmpage.enumTaskActStatus.SUSPEND){
            //根据汇聚类型判断
            if(taskAct.c_from_rule === cmpage.enumActFromRule.DEFINE || act.c_type === cmpage.enumActType.NORMAL_MAN){
                //等待自定义的方法被调用后继续往下走, 人为参与的节点类似
                cmpage.debug(taskAct,&#x27;task_act.canRun --- taskAct --- 等待...&#x27;);
                taskAct.c_status = cmpage.enumTaskActStatus.WAIT;
                await this.save();
                return false;
            }else if(taskAct.c_from_rule === cmpage.enumActFromRule.ORDER){
                return true;
            }else{
                let actCnt = await this.getFromTasksWithEnd();
                if(actCnt.cntEnd &gt;0){
                    if(taskAct.c_from_rule === cmpage.enumActFromRule.OR_JOIN || (actCnt.cnt === actCnt.cntEnd)
                    || (taskAct.c_from_rule === cmpage.enumActFromRule.VOTES_JOIN &amp;&amp; actCnt.cntEnd &gt;= taskAct.c_votes)){
                        return true;
                    }else{
                        taskAct.c_status = cmpage.enumTaskActStatus.PENDING;    //转 汇聚中
                        await this.save();
                        return false;
                    }
                }else{
                    taskAct.c_status = cmpage.enumTaskActStatus.PENDING;    //转 汇聚中
                    await this.save();
                    return false;
                }
            }
        }else if(taskAct.c_status === cmpage.enumTaskActStatus.PENDING){
            //根据汇聚情况判断
            let actCnt = await this.getFromTasksWithEnd();
            if(actCnt.cntEnd &gt;0){
                return (taskAct.c_from_rule === cmpage.enumActFromRule.OR_JOIN || (actCnt.cnt === actCnt.cntEnd)
                    || (taskAct.c_from_rule === cmpage.enumActFromRule.VOTES_JOIN &amp;&amp; actCnt.cntEnd &gt;= taskAct.c_votes));
            }
        }
        return false;
    }

    /**
     * 自定义from规则，一般用于需要中断（等待）的操作完成后，调用本方法&lt;br/&gt;
     * 子类中可以重写本方法实现更多的控制逻辑
     * @method  defineFromRule
     */
    async defineFromRule(){
        if(this.taskAct.c_status ===cmpage.enumTaskActStatus.WAIT){
            this.taskAct.c_status = cmpage.enumTaskActStatus.RUN;
            await this.save();
        }
    }

    /**
     * 运行一个流程实例的活动(流程节点)
     * @method  fwRun
     */
    async fwRun(isPass){
        cmpage.debug(isPass,&#x27;task_act.fwRun - isPass&#x27;);
        if(isPass || await this.canRun() ) {
            this.taskAct.c_status = cmpage.enumTaskActStatus.RUN;
            await this.save();
            //执行本节点，子类中可以加入其他业务逻辑
            if (think.isEmpty(this.act)) {
                this.act = this.model(&#x27;act&#x27;).getActById(this.taskAct.c_act);
            }
            let btns = cmpage.arrFromString(this.act.c_form_btn);
            debug(btns, &#x27;task_act.fwRun - btns&#x27;);
            for (let btn of btns) {
                if (!think.isEmpty(btn.fn)) {         //如果表单按钮设置有函数调用，则调用
                    let fnModel = cmpage.service(btn.model);
                    if (think.isFunction(fnModel[btn.fn])) {
                        await fnModel[btn.fn](this.taskAct, this.act, this.user);
                    }

                }
            }

            //结束本节点
            await this.fwEnd();
        }
    }

    /**
     * 挂起一个流程实例的活动(流程节点)
     * @method  fwSuspend
     */
    async fwSuspend(){
        if(this.taskAct.c_status ===cmpage.enumTaskActStatus.RUN || this.taskAct.c_status ===cmpage.enumTaskActStatus.WAIT){
            this.taskAct.c_status = cmpage.enumTaskActStatus.SUSPEND;
            await this.save();
        }
    }

    /**
     * 终止一个流程实例的活动(流程节点)
     * @method  fwTerminate
     */
    async fwTerminate(){
        if(this.taskAct.c_status !== cmpage.enumTaskActStatus.TERMINATE &amp;&amp; this.taskAct.c_status !== cmpage.enumTaskActStatus.END
            &amp;&amp; this.taskAct.c_status !== cmpage.enumTaskActStatus.NO_BEGIN ){
            this.taskAct.c_status = cmpage.enumTaskActStatus.TERMINATE;
            await this.save();
            //判断，如果当前节点都已经终止，则终止本流程实例，一般是自动终止的时候要检查，手动的话通过调用proc.fwTerminate来进行
            let taskActs = await this.getTaskActs(this.taskAct.c_task);
            let canTerminate = true;
            for(let ta of taskActs){
                if(ta.c_status !== cmpage.enumTaskActStatus.TERMINATE &amp;&amp; ta.c_status !== cmpage.enumTaskActStatus.END
                    &amp;&amp; ta.c_status !== cmpage.enumTaskActStatus.NO_BEGIN){
                    canTerminate = false;
                }
            }
            if(canTerminate) {
                await this.model(&#x27;proc&#x27;).fwTerminate(this.taskAct.c_task, this.user);
            }
        }

    }


    /**
     * 正常结束一个流程实例的活动(流程节点)
     * @method  fwEnd
     */
    async fwEnd(){
        let taskAct = this.taskAct;
        if(taskAct.c_status ===cmpage.enumTaskActStatus.RUN){
            taskAct.c_status = cmpage.enumTaskActStatus.END;
            await this.save();
            if(this.act.c_type == cmpage.enumActType.END){
                await this.model(&#x27;proc&#x27;).fwEnd(this.taskAct.c_task, this.user);
                cmpage.debug(this.taskAct,&#x27;task_act.fwEnd - taskAct - 结束task&#x27;);
            }else{
                //找去向节点,根据去向规则进行Run
                cmpage.debug(taskAct,&#x27;task_act.fwEnd --- taskAct --- 此节点处，找去向节点&#x27;);
                let toTaskActs = await this.getToTaskActs(taskAct);
                if(this.act.c_to_rule === cmpage.enumActToRule.ORDER || this.act.c_to_rule === cmpage.enumActToRule.AND_SPLIT ){
                    for(let ta of toTaskActs ){
                        await this.model(&#x27;act&#x27;).fwRun(ta.id,this.user);
                        cmpage.debug(ta,&#x27;task_act.fwEnd --- toTaskActs.ta --- 此处直接往下&#x27;);
                    }
                }else if(this.act.c_to_rule === cmpage.enumActToRule.OR_SPLIT){
                    //或分支为条件分支，有一个满足条件则继续，没有分支能满足条件则任务终止，因此需要表单填写后先进行有效性的验证
                    //根据分支路径上的业务规则进行判断
                    this.toPaths = await this.model(&#x27;act_path&#x27;).getToActPaths(this.act.id,this.act.c_proc);
                    for(let path of this.toPaths ){
                        if(await this.defineOrSplit(path)){
                            for(let ta of toTaskActs){
                                if(ta.c_act === path.c_to){
                                    await this.model(&#x27;act&#x27;).fwRun(ta.id,this.user);
                                    cmpage.debug(ta,&#x27;task_act.fwEnd --- toTaskActs.ta --- 或分支往下&#x27;);
                                    return;
                                }
                            }
                        }
                    }
                    //let rand = cmpage.getRandomNum(0,toTaskIds.length -1);
                    //this.model(&#x27;act&#x27;).fwRun(toTaskIds[rand],user);
                }else{
                    await this.defineToRule();
                }
            }
        }

    }
    /**
     * 当节点去向规则为 或分支 的时候，通过本方法判断取哪一条路径继续 &lt;br/&gt;
     * 子类中可以重写本方法实现具体的判断逻辑，可以在路径中事先设置条件值，便于调整
     * @method  defineOrSplit
     * @return {boolean}  是否通过该路径
     * @params {object} path 去向的某一个路径
     */
    async defineOrSplit(path){
        await this.domainGetData();

        //此处实现了常规的条件判断处理
        if(!think.isEmpty(path.c_domain)){
            let rule = eval(&quot;(&quot;+path.c_domain+&quot;)&quot;);
            if(!think.isEmpty(rule[&#x27;fn&#x27;])){      //通过某个模块的某个方法来判断是否可以通过改路径
                let fnModel = cmpage.service(rule[&#x27;model&#x27;]);
                if(think.isFunction(fnModel[ rule[&#x27;fn&#x27;] ])){
                    return await fnModel[  rule[&#x27;fn&#x27;] ](this.taskAct, this.act, user);
                }
            }else if(think.isArray(rule)){      //形如： [{field:&quot;c_days&quot;,op:&quot;&gt;&quot;,value:1},{field:&quot;c_days&quot;,op:&quot;&lt;=&quot;,value:3}]
                let where = [];
                for(let item of rule){
                    where.push(&#x60;(${ this.taskAct.domainData[ item[&#x27;field&#x27;] ] } ${item[&#x27;op&#x27;]} ${item[&#x27;value&#x27;]})&#x60;);
                }
                cmpage.debug(where.join(&#x27; &amp;&amp; &#x27;),&#x27;task_act.defineOrSplit - to path where&#x27;);
                return  eval(&quot;(&quot;+ where.join(&#x27; &amp;&amp; &#x27;) +&quot;)&quot;);
            }
        }

        return false;
    }

    /**
     * 取当前节点的业务相关数据，存放于 taskAct.domainData 中 &lt;br/&gt;
     * 子类中可以重写本方法实现具体的取业务数据方法
     * @method  domainGetData
     * @return {object}  增加业务对象数据后的节点对象
     */
    async domainGetData(){
        this.taskAct.domainData = {};
        let task = await this.model(&#x27;task&#x27;).getTask(this.taskAct.c_task);
        cmpage.debug(task,&#x27;task_act.deomainGetData - task&#x27;);
        if(!think.isEmpty(task.c_link_type)){
            this.taskAct.domainData =  await this.model(task.c_link_type).where({id:task.c_link}).find();
        }
        cmpage.debug(this.taskAct.domainData,&#x27;task_act.domainGetData - this.taskAct.domainData&#x27;);

        //子类中可以增加其他业务规则
    }
    /**
     * 自定义to规则，一般用于需要中断（等待）的操作完成后，调用本方法&lt;br/&gt;
     * 子类中可以重写本方法实现更多的控制逻辑
     * @method  defineToRule
     * @return {object}  任务节点对象
     */
    async defineToRule(){
        if(think.isEmpty(this.toTaskActs)){
            this.toTaskActs = await this.getToTaskActs(this.taskAct);
        }
        //子类中增加自定义规则
    }

    /**
     * 保存任务的活动(流程节点), taskAct结构来自于vw_task_act&lt;br/&gt;
     * 子类中可以重写本方法来增加其他逻辑，比如保存其他业务表数据等, 此处可以改用缓存机制
     * @method  save
     */
    async save(){
        let md = cmpage.objPropertysFromOtherObj({},this.taskAct,[&#x27;c_task&#x27;,&#x27;c_act&#x27;,&#x27;c_status&#x27;,&#x27;c_user&#x27;,
                    &#x27;c_memo&#x27;,&#x27;c_link&#x27;,&#x27;c_link_type&#x27;]);
        if(!think.isEmpty(this.user)){
            md.c_user = this.user.id;
        }
        md.c_time = think.datetime();
        if(!think.isEmpty(md)){
            await this.model(&#x27;fw_task_act&#x27;).where({id:this.taskAct.id}).update(md);
            await this.addTaskSt();
        }
    }

    /**
     * 增加流程实例的活动节点状态记录，记录某个活动(流程节点)发生的时间及当时状态&lt;br/&gt;
     * 子类中重写本方法可以定制流程状态的记录方式，如在具体业务状态表中增加记录等
     * @method  addTaskSt
     * @params {string} desc 状态描述
     */
    async addTaskSt( desc){
        let taskAct = this.taskAct;
        let md = {c_proc:taskAct.c_proc,c_act:taskAct.c_act,c_task:taskAct.c_task, c_task_act:taskAct.id,
            c_time:taskAct.c_time, c_user:taskAct.c_user};
        //组成状态描述
        if(taskAct.c_status === cmpage.enumActType.NORMAL_MAN || taskAct.c_status === cmpage.enumActType.NORMAL_AUTO ){
            md.c_desc = think.isEmpty(desc) ? &#x60;节点(${await this.model(&#x27;act&#x27;).getNameById(taskAct.c_act)})
                    ${this.model(&#x27;cmpage/utils&#x27;).getEnumName(md.c_status,&#x27;TaskStatus&#x27;)}&#x60; : desc;
            md.id = await this.model(&#x27;fw_task_st&#x27;).add(md);
            await this.model(&#x27;fw_task_st_his&#x27;).add(md);
            return md.id;
        }
        return 0;
    }

    /**
     * 根据任务节点ID统计汇聚来源任务节点的完成数，供其他方法调用
     * @method  getFromTasksWithEnd
     * @return {int} 来源的任务节点的完成数
     * @params {object} taskAct 任务节点对象
     */
    async getFromTasksWithEnd(){
        cmpage.debug(this.taskAct,&#x27;task_act.getFromTasksWithEnd - taskAct&#x27;);
        if(think.isEmpty(this.fromTaskActs)){
            this.fromTaskActs = await this.getFromTaskActs(this.taskAct);
        }
        //cmpage.debug(list);
        let cntEnd =0;
        for(let md of this.fromTaskActs){
            if (md.c_status === cmpage.enumTaskActStatus.END) {
                cntEnd += 1;
            }
        }
        return cntEnd;
    }

    /**
     * 根据任务节点ID取汇聚来源任务节点ID的列表，供其他方法调用
     * @method  getFromTaskActs
     * @return {Array} 来源的任务节点的列表
     * @params {object} taskAct 任务节点对象
     */
    async getFromTaskActs(taskAct){
        cmpage.debug(taskAct,&#x27;task_act.getFromTaskIds&#x27;)
        let fromArr =await this.model(&#x27;act_path&#x27;).getFromActIds(taskAct.c_act, taskAct.c_proc);
        let list = await this.model(&#x27;fw_task_act&#x27;).where({c_task:taskAct.c_task}).select();
        let ret =[];
        for(let md of list){
            for(let fromID of fromArr) {
                if (md.c_act === fromID) {
                    ret.push(md);
                }
            }
        }
        return ret;
    }

    /**
     * 根据任务节点ID取分支去向的任务节点ID的列表，供其他方法调用
     * @method  getToTaskIds
     * @return {Array} 去向的任务节点的列表
     * @params {object} taskAct 任务节点对象
     */
    async getToTaskActs(taskAct){
        debug(taskAct,&#x27;task_act.getToTaskActs ---- taskAct&#x27;);
        let toArr =await this.model(&#x27;act_path&#x27;).getToActIds(taskAct.c_act, taskAct.c_proc);
        let list = await this.query(&#x60;select * from fw_task_act where c_task=${taskAct.c_task}&#x60;);
        let ret =[];
        for(let md of list){
            for(let toID of toArr) {
                if (md.c_act === toID) {
                    ret.push(md);
                }
            }
        }
        return ret;
    }

    /**
     * 根据任务ID取任务节点的列表，供其他方法调用
     * @method  getTaskActs
     * @return {Array} 任务节点ID的列表
     * @params {int} taskID 任务ID
     */
    async getTaskActs(taskID){
        return await this.query(&#x60;select * from fw_task_act where c_task=${taskID}&#x60;);
    }


    /**
     * 取流程实例（任务）的活动节点对象，此处可使用缓存机制改进性能
     * @method  getTaskAct
     * @return {object} 流程实例的节点对象
     * @params {object} taskActID 任务对象的节点ID
     */
    async getTaskAct(taskActID){
        return await this.getTaskActById(taskActID);
    }
    async getTaskActById(taskActID){
        return await this.model(&#x27;vw_task_act&#x27;).where({id:taskActID}).find();
    }

}

    </pre>
</div>

                </div>
            </div>
        </div>
    </div>
<a id="gotoTop" class='well well-small' href='#'>
    Top
</a>
<script src="../assets/vendor/jquery/jquery-1.8.2.min.js"></script>
<script src="../assets/vendor/bootstrap/js/bootstrap.min.js"></script>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script src="../assets/js/config.js"></script>
<script src="../assets/js/doc.js"></script>
</body>
</html>
